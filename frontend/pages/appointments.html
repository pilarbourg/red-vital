<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RedVital | Pedir cita</title>
    <link rel="stylesheet" href="../css/index.css" />
    <link rel="stylesheet" href="../css/appointments.css" />
  </head>
  <body>
    <header>
      <section class="title-header">
        <h4>Centro de Donaciones de Sangre</h4>
        <span>|</span>
        <h4>Donar Sangre es Donar Vida</h4>
      </section>
      <section class="header">
        <div class="icon-title-header">
          <img src="../assets/svgs/icon_logo.svg" alt="Small Logo" />
          <h1>REDVITAL</h1>
        </div>

        <nav class="button-container">
          <a href="../../index.html" class="button">Home</a>
          <a href="appointments.html" class="button">Citas</a>
          <a href="areaadmin.html" class="button">Área Administración</a>
          <a href="areadonante.html" class="button">Área Donante</a>
          <a href="areahospitalaria.html" class="button">Área Hospitalaria</a>
          <a href="register.html" class="button">Register</a>
          <a href="login.html" class="button">Login</a>
        </nav>
      </section>
    </header>

    <section class="appt-hero">
      <img
        src="../assets/images/akram-huseyn-fKC9eWRnlGY-unsplash.jpg"
        alt="Sala de donación"
      />
    </section>

    <main class="appt-wrap">
      <section class="appt-grid">
        <section class="appt-card">
          <h2>Pedir Cita</h2>
          <p class="appt-lead">
            Selecciona fecha y departamento para ver la disponibilidad del día.
            Elige una franja para auto-rellenar hora y doctor.
          </p>

          <form id="apptForm" class="appt-form">
            <label>
              Nombre y Apellidos
              <input id="name" placeholder="Tu nombre completo" required />
            </label>
            <label>
              Género
              <select id="gender">
                <option>F</option>
                <option>M</option>
                <option>Otro</option>
              </select>
            </label>
            <label>
              Email
              <input
                id="email"
                type="email"
                placeholder="tucorreo@ejemplo.com"
                required
              />
            </label>
            <label>
              Teléfono
              <input id="phone" placeholder="+34 600 000 000" />
            </label>
            <label>
              Fecha
              <input id="date" type="date" required />
            </label>
            <label>
              Hora
              <input id="time" type="time" required />
            </label>
            <label>
              Doctor
              <input id="doctor" placeholder="Dr./Dra." />
            </label>
            <label>
              Departamento
              <select id="dept">
                <option>Banco de Sangre</option>
                <option>Hematología</option>
                <option>General</option>
              </select>
            </label>
            <label class="full">
              Comentarios
              <textarea id="msg" rows="3" placeholder="Comentarios…"></textarea>
            </label>

            <button class="appt-primary full">SUBMIT</button>
          </form>

          <p id="feedback" class="appt-feedback hidden">
            ¡Cita registrada! La disponibilidad se ha actualizado.
          </p>
        </section>

        <aside class="appt-card appt-schedule">
          <h2 id="scheduleTitle">Horario</h2>
          <ul id="slots" class="appt-slotlist">
          </ul>
        </aside>
      </section>
    </main>

    <section class="appt-banner">
      <img src="../assets/images/logo_RedVital.png" alt="RedVital" />
    </section>

    <footer class="site-footer">
      <div class="footer-content">
        <div class="footer-brand">
          <img src="../assets/svgs/icon_logo.svg" alt="RedVital Logo" />
          <span>RedVital</span>
        </div>
        <div class="footer-links">
          <a href="areaadmin.html">Admin</a>
          <a href="areadonante.html">Donante</a>
          <a href="areahospitalaria.html">Hospital</a>
        </div>
        <div class="footer-copy">
          &copy; 2025 RedVital | All rights reserved
        </div>
      </div>
    </footer>
    
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const form     = document.getElementById('apptForm');
        const feedback = document.getElementById('feedback');
        const slotsEl  = document.getElementById('slots');

        let citas = [];   // aquí guardamos lo que venga de la API

        // ---- 1. Cargar citas desde el backend ----
        async function loadCitas() {
          try {
            const res = await fetch('/api/citas');
            if (!res.ok) throw new Error('Error al cargar citas');
            citas = await res.json();
            render();
          } catch (err) {
            console.error(err);
            slotsEl.innerHTML = "<p class='appt-empty'>Error al cargar citas.</p>";
          }
        }

        // ---- 2. Pintar la lista de citas ----
        function render() {
          if (!citas.length) {
            slotsEl.innerHTML = "<p class='appt-empty'>No hay citas.</p>";
            return;
          }

          const sorted = [...citas].sort((a, b) =>
            (a.fecha + (a.hora || '')).localeCompare(b.fecha + (b.hora || ''))
          );

          const html = sorted
            .map(c => `
              <li class="appt-slot">
                <div class="appt-slot-main">
                  <strong>${c.fecha}</strong> · ${c.hora || '—'}
                  <span class="appt-badge">${c.departamento || 'General'}</span>
                </div>
                <div class="appt-slot-sub">
                  Doctor: ${c.doctor || 'Por asignar'}
                  · <em>${c.status || 'PENDIENTE'}</em>
                </div>
                <div class="appt-actions">
                  <button data-act="done"    data-id="${c.id}">Completada</button>
                  <button data-act="resched" data-id="${c.id}">Reprogramar</button>
                  <button data-act="cancel"  data-id="${c.id}">Cancelar</button>
                </div>
              </li>
            `)
            .join('');

          slotsEl.innerHTML = html;
        }

        // ---- 3. Enviar formulario → crear cita en la BD ----
        form.addEventListener('submit', async (e) => {
          e.preventDefault();

          const v = (id) => document.getElementById(id).value.trim();

          if (!v('name') || !v('email') || !v('date') || !v('time')) {
            alert('Completa nombre, email, fecha y hora.');
            return;
          }

          // Mientras no hay login, usamos IDs fijos:
          const donante_id  = 1;
          const hospital_id = 1;

          const body = {
            donante_id,
            hospital_id,
            fecha:        v('date'),
            hora:         v('time'),
            doctor:       v('doctor'),
            departamento: v('dept'),
            mensaje:      v('msg'),
          };

          try {
            const res = await fetch('/api/citas', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(body),
            });

            if (!res.ok) {
              const err = await res.json().catch(() => ({}));
              throw new Error(err.error || 'Error al crear cita');
            }

            form.reset();
            feedback.classList.remove('hidden');
            setTimeout(() => feedback.classList.add('hidden'), 2500);

            await loadCitas();
          } catch (err) {
            console.error(err);
            alert('No se ha podido crear la cita.');
          }
        });

        // ---- 4. Botones de cada cita: completar / reprogramar / cancelar ----
        slotsEl.addEventListener('click', async (e) => {
          const btn = e.target.closest('button[data-act]');
          if (!btn) return;

          const id  = btn.dataset.id;
          const act = btn.dataset.act;

          try {
            if (act === 'cancel') {
              await fetch(`/api/citas/${id}`, { method: 'DELETE' });
            }

            if (act === 'done') {
              await fetch(`/api/citas/${id}`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status: 'CONFIRMADA' }),
              });
            }

            if (act === 'resched') {
              const current = citas.find(c => String(c.id) === String(id));
              const nf = prompt('Nueva fecha (YYYY-MM-DD):', current?.fecha || '');
              const nh = prompt('Nueva hora (HH:MM):', current?.hora || '');
              if (nf && nh) {
                await fetch(`/api/citas/${id}`, {
                  method: 'PATCH',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ fecha: nf, hora: nh, status: 'PENDIENTE' }),
                });
              }
            }

            await loadCitas();
          } catch (err) {
            console.error(err);
            alert('No se ha podido actualizar la cita.');
          }
        });

        // ---- 5. Primera carga ----
        loadCitas();
      });
    </script>
  </body>
</html>