<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RedVital | Pedir cita</title>
    <!-- Estilo global del header y el footer -->
    <link rel="stylesheet" href="../css/index.css" />
    <!-- Estilo específico de la página de citas -->
    <link rel="stylesheet" href="../css/appointments.css" />
  </head>
  <body>
    <header>
      <section class="title-header">
        <h4>Centro de Donaciones de Sangre</h4>
        <span>|</span>
        <h4>Donar Sangre es Donar Vida</h4>
      </section>

      <section class="header">
        <div class="icon-title-header">
          <img src="../assets/svgs/icon_logo.svg" alt="Small Logo" />
          <h1>RedVital</h1>
        </div>
        <nav class="button-container">
          <a href="../../index.html" class="button">Home</a>
          <a href="../../index.html" class="button">About Us</a>
          <a href="../../index.html" class="button">Services</a>
          <a href="../../index.html" class="button">Doctors</a>
          <a href="../../index.html" class="button">News</a>
          <a href="../../index.html" class="button">Contact</a>
          <a href="../../index.html" class="button">Register</a>
          <a href="../../index.html" class="button">Login</a>
        </nav>
      </section>
    </header>

    <section class="appt-hero">
      <img src="../assets/images/akram-huseyn-fKC9eWRnlGY-unsplash.jpg" alt="Sala de donación" />
    </section>

    <!-- Contenido principal: formulario + disponibilidad -->
    <main class="appt-wrap">
      <section class="appt-grid">
        <!-- Columna izquierda: Pedir Cita -->
        <section class="appt-card">
          <h2>Pedir Cita</h2>
          <p class="appt-lead">
            Selecciona fecha y departamento para ver la disponibilidad del día. Elige una franja para auto-rellenar hora y doctor.
          </p>

          <form id="apptForm" class="appt-form">
            <label> Nombre y Apellidos
              <input id="name" placeholder="Tu nombre completo" required />
            </label>
            <label> Género
              <select id="gender">
                <option>F</option><option>M</option><option>Otro</option>
              </select>
            </label>
            <label> Email
              <input id="email" type="email" placeholder="tucorreo@ejemplo.com" required />
            </label>
            <label> Teléfono
              <input id="phone" placeholder="+34 600 000 000" />
            </label>
            <label> Fecha
              <input id="date" type="date" required />
            </label>
            <label> Hora
              <input id="time" type="time" required />
            </label>
            <label> Doctor
              <input id="doctor" placeholder="Dr./Dra." />
            </label>
            <label> Departamento
              <select id="dept">
                <option>Banco de Sangre</option>
                <option>Hematología</option>
                <option>General</option>
              </select>
            </label>
            <label class="full"> Comentarios
              <textarea id="msg" rows="3" placeholder="Comentarios…"></textarea>
            </label>

            <button class="appt-primary full">SUBMIT</button>
          </form>

          <p id="feedback" class="appt-feedback hidden">¡Cita registrada! La disponibilidad se ha actualizado.</p>
        </section>

        <!-- Columna derecha: Disponibilidad (no lista de pacientes) -->
        <aside class="appt-card appt-schedule">
          <h2 id="scheduleTitle">Horario</h2>
          <ul id="slots" class="appt-slotlist"><!-- render JS --></ul>
        </aside>
      </section>
    </main>

    <!-- Banda de imagen -->
    <section class="appt-banner">
      <img src="../assets/images/logo_RedVital.png" alt="RedVital"/>
    </section>

    <script>
      // ====== Datos base (sin backend) ======
      const KEY = "appointments";
      const load = () => JSON.parse(localStorage.getItem(KEY) || "[]");
      const save = (v) => localStorage.setItem(KEY, JSON.stringify(v));

      // Doctores por departamento (rotamos en las franjas)
      const DOCTORS = {
        "Banco de Sangre": ["Dra. Ruiz", "Dr. López"],
        "Hematología": ["Dr. Pérez", "Dra. Martín"],
        "General": ["Dr. García", "Dra. Alba"]
      };

      // Franjas base del día
      const BASE_TIMES = ["09:00","09:30","10:00","10:30","11:00","11:30","12:00","12:30","16:00","16:30"];

      // Semilla de ejemplo SOLO si no hay datos
      if (load().length === 0) {
        save([
          { name:"Ana",  email:"ana@example.com",  date:"2025-11-05", time:"10:00", doctor:"Dra. Ruiz", dept:"Banco de Sangre" },
          { name:"Luis", email:"luis@example.com", date:"2025-11-08", time:"12:30", doctor:"Dr. Pérez",  dept:"Hematología" }
        ]);
      }

      // ====== Referencias DOM ======
      const form   = document.getElementById("apptForm");
      const fb     = document.getElementById("feedback");
      const slotsEl= document.getElementById("slots");
      const titleEl= document.getElementById("scheduleTitle");
      const dateEl = document.getElementById("date");
      const deptEl = document.getElementById("dept");
      const timeEl = document.getElementById("time");
      const docEl  = document.getElementById("doctor");

      // Último listado de franjas mostradas (para saber qué eligió)
      let currentSlots = [];

      // Genera disponibilidad para una fecha+depto verificando reservas existentes
      function buildSchedule(date, dept){
        const appts = load().filter(a => a.date === date && a.dept === dept);
        return BASE_TIMES.map((t, i) => {
          const doctor = DOCTORS[dept][i % DOCTORS[dept].length];
          const booked = appts.some(a => a.time === t && a.doctor === doctor);
          return { time: t, doctor, booked };
        });
      }

      // Pinta la disponibilidad
      function renderAvailability(){
        const date = dateEl.value;
        const dept = deptEl.value;

        if (!date || !dept) {
          titleEl.textContent = "Horario";
          slotsEl.innerHTML = "<p class='appt-empty'>Elige fecha y departamento para ver disponibilidad…</p>";
          currentSlots = [];
          return;
        }

        titleEl.textContent = `Horario ${date} · ${dept}`;
        const slots = buildSchedule(date, dept);
        currentSlots = slots;

        const html = slots.map((s, idx) => `
          <li class="appt-slot ${s.booked ? "is-booked" : "is-free"}">
            <div class="appt-slot-main">
              <strong>${s.time}</strong>
              <span class="appt-badge">${s.doctor}</span>
            </div>
            <div class="appt-actions">
              ${s.booked
                ? '<span class="tag tag-booked">Reservado</span>'
                : `<button data-act="pick" data-i="${idx}">Elegir</button>`}
            </div>
          </li>
        `).join("");

        slotsEl.innerHTML = html || "<p class='appt-empty'>Sin franjas para ese día.</p>";
      }

      // Elegir franja: auto-rellena hora y doctor
      slotsEl.addEventListener("click", (e) => {
        const btn = e.target.closest("button[data-act='pick']");
        if (!btn) return;
        const idx = +btn.dataset.i;
        const s = currentSlots[idx];
        if (!s || s.booked) return;

        timeEl.value = s.time;
        docEl.value  = s.doctor;

        // Feedback visual en la lista
        [...slotsEl.querySelectorAll(".appt-slot")].forEach(li => li.classList.remove("picked"));
        btn.closest(".appt-slot").classList.add("picked");
      });

      // Cambios de fecha/departamento → refrescar disponibilidad
      dateEl.addEventListener("change", renderAvailability);
      deptEl.addEventListener("change", renderAvailability);

      // Enviar cita → guardar + refrescar disponibilidad
      form.addEventListener("submit", (e) => {
        e.preventDefault();
        const v = id => document.getElementById(id).value.trim();

        if (!v("name") || !v("email") || !v("date") || !v("time")) {
          alert("Completa nombre, email, fecha y hora.");
          return;
        }

        const list = load();
        list.push({
          name: v("name"),
          gender: v("gender"),
          email: v("email"),
          phone: v("phone"),
          date: v("date"),
          time: v("time"),
          doctor: v("doctor"),
          dept: v("dept"),
          msg: v("msg")
        });
        save(list);

        fb.classList.remove("hidden");
        setTimeout(()=>fb.classList.add("hidden"), 1800);

        form.reset();
        // Mantener fecha/depto para que el usuario vea cómo se bloquea la franja
        dateEl.value = "";
        deptEl.value = "Banco de Sangre";

        renderAvailability();
      });

      // Primer render
      renderAvailability();
    </script>
  </body>
</html>
